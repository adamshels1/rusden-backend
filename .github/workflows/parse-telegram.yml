name: Parse Telegram Channels

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
    - cron: '*/30 * * * *'

  # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é
  workflow_dispatch:

jobs:
  parse:
    runs-on: ubuntu-latest

    steps:
    - name: Trigger Telegram Parsing
      run: |
        echo "üöÄ Starting Telegram channels parsing..."

        response=$(curl -s -X POST https://rusden-backend.onrender.com/api/cron/parse \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          -H "Content-Type: application/json")

        echo "üìä Response: $response"

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞
        if echo "$response" | grep -q '"success":true'; then
          echo "‚úÖ Parsing completed successfully!"
        else
          echo "‚ùå Parsing failed!"
          exit 1
        fi

    - name: Wait and Verify
      run: |
        echo "‚è≥ Waiting 10 seconds for processing..."
        sleep 10

        echo "üîç Verifying API is still responsive..."
        curl -s https://rusden-backend.onrender.com/health || exit 1

        echo "‚úÖ Health check passed!"